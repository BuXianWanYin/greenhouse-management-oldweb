# 机械类型农资归还功能 - 后端修改说明

## 一、业务逻辑说明

### 1. 农资类型区分
- **物料类型 (resourceType = '0')**：消耗品，使用后直接消耗，库存减少，不可归还
- **机械类型 (resourceType = '1')**：设备工具，可重复使用，需要领用和归还流程

### 2. 使用类型说明
- **领用 (usageType = '0')**：从库存中取出使用
  - 机械类型：库存减少，状态设为"使用中"(status = '2')，后续可归还
  - 物料类型：库存减少，状态设为"正常"(status = '0')，不可归还
- **消耗 (usageType = '1')**：直接消耗，库存减少，状态为"正常"(status = '0')
- **入库 (usageType = '2')**：归还到库存，库存增加，状态设为"正常"(status = '0')

### 3. 状态字段扩展
当前 `status` 字段含义：
- `'0'` = 正常（已归还/已消耗）
- `'1'` = 已撤销
- `'2'` = 使用中（未归还）- **新增状态**

## 二、后端接口修改

### 1. 新增归还接口

**接口路径：** `PUT /agriculture/resource/usage/return/{usageId}`

**功能说明：** 归还已领用的机械类型农资

**请求参数：**
- `usageId` (路径参数)：使用记录ID

**业务逻辑：**
1. 根据 `usageId` 查询使用记录
2. 验证：
   - 使用记录必须存在
   - 使用类型必须是"领用"(`usageType = '0'`)
   - 状态必须是"使用中"(`status = '2'`)
   - 对应的农资类型必须是"机械"(`resourceType = '1'`)
3. 更新库存：
   - 根据 `resourceId` 查找对应的库存记录
   - 将 `currentStock` 增加 `usageQuantity`（归还数量）
4. 更新使用记录：
   - 将 `status` 从 `'2'`（使用中）改为 `'0'`（正常/已归还）
   - 更新 `updateTime` 为当前时间
   - 更新 `updateBy` 为当前用户ID
5. 返回成功结果

**返回数据：**
```json
{
  "code": 200,
  "msg": "归还成功"
}
```

**错误处理：**
- 使用记录不存在：返回错误信息
- 不是领用类型：返回"该记录不是领用类型，无法归还"
- 状态不是使用中：返回"该农资已归还或已撤销"
- 不是机械类型：返回"只有机械类型农资可以归还"
- 库存记录不存在：返回"库存记录不存在"

### 2. 修改新增使用记录接口

**接口路径：** `POST /agriculture/resource/usage`

**修改点：**
1. 根据 `resourceId` 查询农资类型
2. 如果是机械类型且使用类型是"领用"：
   - 库存减少（`currentStock` 减少 `usageQuantity`）
   - 状态设置为 `'2'`（使用中）
3. 如果是物料类型且使用类型是"消耗"：
   - 库存减少（`currentStock` 减少 `usageQuantity`）
   - 状态设置为 `'0'`（正常）
4. 如果是"入库"类型：
   - 库存增加（`currentStock` 增加 `usageQuantity`）
   - 状态设置为 `'0'`（正常）

**伪代码示例：**
```java
// 查询农资类型
AgricultureResource resource = resourceService.getById(resourceId);
String resourceType = resource.getResourceType();

// 根据使用类型和农资类型处理库存和状态
if ("2".equals(usageType)) {
    // 入库：库存增加
    inventory.setCurrentStock(inventory.getCurrentStock() + usageQuantity);
    usage.setStatus("0"); // 正常
} else if ("0".equals(usageType)) {
    // 领用：库存减少
    inventory.setCurrentStock(inventory.getCurrentStock() - usageQuantity);
    if ("1".equals(resourceType)) {
        // 机械类型：状态设为使用中
        usage.setStatus("2");
    } else {
        // 物料类型：状态设为正常
        usage.setStatus("0");
    }
} else if ("1".equals(usageType)) {
    // 消耗：库存减少
    inventory.setCurrentStock(inventory.getCurrentStock() - usageQuantity);
    usage.setStatus("0"); // 正常
}
```

### 3. 修改删除使用记录接口

**接口路径：** `DELETE /agriculture/resource/usage/{usageId}`

**修改点：**
删除使用记录时，需要恢复库存：
1. 如果是"领用"或"消耗"类型：库存需要增加（恢复）
2. 如果是"入库"类型：库存需要减少（恢复）
3. 如果状态是"使用中"(`status = '2'`)，删除时需要恢复库存

**伪代码示例：**
```java
// 查询使用记录
ResourceUsage usage = usageService.getById(usageId);

// 恢复库存
if ("0".equals(usage.getUsageType()) || "1".equals(usage.getUsageType())) {
    // 领用或消耗：恢复库存
    inventory.setCurrentStock(inventory.getCurrentStock() + usage.getUsageQuantity());
} else if ("2".equals(usage.getUsageType())) {
    // 入库：减少库存
    inventory.setCurrentStock(inventory.getCurrentStock() - usage.getUsageQuantity());
}

// 删除使用记录
usageService.deleteById(usageId);
```

## 三、数据库字段说明

### agriculture_resource_usage 表
- `status` 字段：需要支持 `'2'` 值（使用中）
- 建议添加索引：`idx_resource_id_status` (resourceId, status) 用于快速查询未归还的机械

### agriculture_resource_inventory 表
- `current_stock` 字段：需要支持增加和减少操作
- 建议添加约束：`current_stock >= 0`

## 四、业务规则总结

1. **机械类型农资**：
   - 只能选择"领用"（前端已限制）
   - 领用时：库存减少，状态设为"使用中"
   - 使用完毕后：需要调用归还接口，库存增加，状态改为"已归还"

2. **物料类型农资**：
   - 只能选择"消耗"（前端已限制）
   - 消耗时：库存减少，状态设为"正常"
   - 不可归还

3. **入库操作**：
   - 在库存管理页面进行
   - 库存增加，状态设为"正常"

## 五、测试建议

1. 测试机械类型农资领用流程
2. 测试机械类型农资归还流程
3. 测试物料类型农资消耗流程
4. 测试删除使用记录时的库存恢复
5. 测试边界情况：库存不足、重复归还等

